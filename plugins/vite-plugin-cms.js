import { writeFile, mkdir, readdir, unlink } from "fs/promises";
import { join, resolve } from "path";

/**
 * Vite plugin that fetches CMS content from CloudFront CDN at build time
 * and writes it to src/data/ in the format the web app expects.
 *
 * Falls back to existing local files if CMS URL is not configured or fetch fails.
 */
export default function cmsFetchPlugin(options = {}) {
  let root = "";

  return {
    name: "fetch-cms-content",

    configResolved(config) {
      root = config.root;
    },

    async buildStart() {
      const cmsUrl = options.cmsUrl || process.env.VITE_CMS_CDN_URL;
      if (!cmsUrl) {
        console.warn("[CMS] No VITE_CMS_CDN_URL configured, using local data files");
        return;
      }

      const dataDir = resolve(root, "src/data");
      const files = ["home", "coaches", "faq", "gallery", "testimonials", "contact", "terms", "privacy", "waiver"];
      let fetched = 0;

      for (const file of files) {
        try {
          const url = `${cmsUrl.replace(/\/$/, "")}/content/${file}.json`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          await transformAndWrite(dataDir, file, data);
          fetched++;
          console.log(`[CMS] Fetched and wrote ${file}`);
        } catch (err) {
          console.warn(`[CMS] Failed to fetch ${file}.json: ${err.message}. Using local fallback.`);
        }
      }

      console.log(`[CMS] ${fetched}/${files.length} content files updated from CMS`);
    },
  };
}

// ====================================================================
// Transform CMS JSON â†’ web repo expected file format
// ====================================================================

async function transformAndWrite(dataDir, contentType, data) {
  switch (contentType) {
    case "home":
      return writeHome(dataDir, data);
    case "coaches":
      return writeCoaches(dataDir, data);
    case "faq":
      return writeFaq(dataDir, data);
    case "gallery":
      return writeGallery(dataDir, data);
    case "testimonials":
      return writeTestimonials(dataDir, data);
    case "contact":
      return writeContact(dataDir, data);
    case "terms":
      return writeLegalPage(dataDir, "terms", data);
    case "privacy":
      return writeLegalPage(dataDir, "privacy", data);
    case "waiver":
      return writeLegalPage(dataDir, "waiver", data);
    default:
      console.warn(`[CMS] Unknown content type: ${contentType}`);
  }
}

// --------------------------------------------------------------------
// Home: CMS stores one combined object, web expects 4 separate files
// --------------------------------------------------------------------
async function writeHome(dataDir, data) {
  // homeHero.json
  if (data.hero) {
    await writeJson(join(dataDir, "homeHero.json"), data.hero);
  }

  // homeAbout.json
  if (data.about) {
    await writeJson(join(dataDir, "homeAbout.json"), data.about);
  }

  // homeStats.json
  if (data.stats) {
    await writeJson(join(dataDir, "homeStats.json"), { stats: data.stats });
  }

  // coreValues.json
  if (data.coreValues) {
    await writeJson(join(dataDir, "coreValues.json"), { coreValues: data.coreValues });
  }
}

// --------------------------------------------------------------------
// Coaches: CMS stores array, web expects individual JSON + index JS
// --------------------------------------------------------------------
async function writeCoaches(dataDir, data) {
  const coaches = data.coaches || [];
  if (coaches.length === 0) return;

  const coachDir = join(dataDir, "coaches");
  await mkdir(coachDir, { recursive: true });

  // Write individual coach JSON files
  for (const coach of coaches) {
    const filename = `${coach.id}.json`;
    await writeJson(join(coachDir, filename), coach);
  }

  // Regenerate coachInfo.js with imports
  const imports = coaches
    .sort((a, b) => (a.order || 0) - (b.order || 0))
    .map((c) => {
      const varName = slugToVar(c.id);
      return `import ${varName} from './coaches/${c.id}.json';`;
    });

  const varNames = coaches
    .sort((a, b) => (a.order || 0) - (b.order || 0))
    .map((c) => slugToVar(c.id));

  const coachInfoJs = [
    "// Auto-generated by CMS build plugin",
    ...imports,
    "",
    `export const coaches = [${varNames.join(", ")}].sort(`,
    "  (a, b) => a.order - b.order",
    ");",
    "",
    "export const coachInfo = coaches[0];",
    "",
  ].join("\n");

  await writeFile(join(dataDir, "coachInfo.js"), coachInfoJs, "utf-8");
}

// --------------------------------------------------------------------
// FAQ: CMS and web use same format
// --------------------------------------------------------------------
async function writeFaq(dataDir, data) {
  await writeJson(join(dataDir, "faqs.json"), { faqs: data.faqs || [] });
}

// --------------------------------------------------------------------
// Gallery: CMS stores combined, web expects individual files + index JS
// --------------------------------------------------------------------
async function writeGallery(dataDir, data) {
  const images = data.images || [];
  const campPhotos = data.campPhotos || [];
  const videos = data.videos || [];

  // -- Gallery images --
  if (images.length > 0) {
    const galleryDir = join(dataDir, "gallery");
    await mkdir(galleryDir, { recursive: true });

    // Clean existing CMS-generated gallery files (keep manually-added ones)
    for (const img of images) {
      const filename = toSlug(img.id || img.alt || `image-${img.id}`) + ".json";
      await writeJson(join(galleryDir, filename), {
        id: img.id,
        src: img.src,
        alt: img.alt || "",
        category: img.category || "camps",
        featured: img.featured || false,
      });
    }

    // Regenerate galleryImages.js using import.meta.glob for auto-discovery
    const galleryImagesJs = [
      "// Auto-generated by CMS build plugin",
      "",
      "// Gallery categories",
      `export const galleryCategories = ${JSON.stringify(data.categories || [], null, 2)};`,
      "",
      "// Dynamically import all gallery JSON files",
      "const galleryModules = import.meta.glob('./gallery/*.json', { eager: true });",
      "",
      "export const galleryImages = Object.values(galleryModules)",
      "  .map(module => module.default)",
      "  .filter(img => img && img.src)",
      "  .sort((a, b) => (a.id || 0) - (b.id || 0));",
      "",
      "// Camp photos carousel",
      "const campPhotoModules = import.meta.glob('./camp-photos/*.json', { eager: true });",
      "",
      "export const campPhotos = Object.values(campPhotoModules)",
      "  .map(module => module.default)",
      "  .filter(photo => photo && photo.src)",
      "  .sort((a, b) => (a.order || 0) - (b.order || 0))",
      "  .map(photo => photo.src);",
      "",
    ].join("\n");

    await writeFile(join(dataDir, "galleryImages.js"), galleryImagesJs, "utf-8");
  }

  // -- Camp photos --
  if (campPhotos.length > 0) {
    const campDir = join(dataDir, "camp-photos");
    await mkdir(campDir, { recursive: true });

    for (const photo of campPhotos) {
      const filename = `camp-photo-${photo.id}.json`;
      await writeJson(join(campDir, filename), {
        id: photo.id,
        src: photo.src,
        caption: photo.caption || "",
        order: photo.order || 0,
      });
    }
  }

  // -- Videos --
  if (videos.length > 0) {
    const videoDir = join(dataDir, "videos");
    await mkdir(videoDir, { recursive: true });

    for (const video of videos) {
      const filename = toSlug(video.id || video.title || `video-${video.id}`) + ".json";
      await writeJson(join(videoDir, filename), {
        id: video.id,
        type: video.type || "instagram",
        instagramUrl: video.instagramUrl || "",
        title: video.title || "",
        category: video.category || "highlights",
        featured: video.featured || false,
        order: video.order || 0,
      });
    }
  }
}

// --------------------------------------------------------------------
// Testimonials: CMS stores array, web imports from testimonials.js
// --------------------------------------------------------------------
async function writeTestimonials(dataDir, data) {
  const testimonials = (data.testimonials || []).filter(
    (t) => t.status === "approved" || !t.status
  );

  if (testimonials.length === 0) return;

  // Write as ES module matching existing format
  const items = testimonials.map((t) => ({
    id: t.id,
    name: t.name,
    role: t.role,
    ...(t.playerInfo ? { playerInfo: t.playerInfo } : {}),
    text: t.text,
    featured: t.featured || false,
  }));

  const testimonialsJs = [
    "// Auto-generated by CMS build plugin",
    `export const testimonials = ${JSON.stringify(items, null, 2)};`,
    "",
  ].join("\n");

  await writeFile(join(dataDir, "testimonials.js"), testimonialsJs, "utf-8");

  // Also write individual JSON files (for import.meta.glob consumers)
  const testimonialsDir = join(dataDir, "testimonials");
  await mkdir(testimonialsDir, { recursive: true });

  for (const t of testimonials) {
    const slug = toSlug(t.name || `testimonial-${t.id}`);
    const filename = `${String(t.id).padStart(4, "0")}-${slug}.json`;
    await writeJson(join(testimonialsDir, filename), {
      id: t.id,
      author: t.name,
      role: t.playerInfo ? `${t.role} (${t.playerInfo})` : t.role,
      text: t.text,
      featured: t.featured || false,
    });
  }
}

// --------------------------------------------------------------------
// Contact: write as JSON (may be consumed by a future component)
// --------------------------------------------------------------------
async function writeContact(dataDir, data) {
  await writeJson(join(dataDir, "contact.json"), {
    email: data.email || "",
    phone: data.phone || "",
    instagram: data.instagram || "",
    address: data.address || "",
  });
}

// --------------------------------------------------------------------
// Legal pages (terms, privacy, waiver): CMS and web use same format
// --------------------------------------------------------------------
async function writeLegalPage(dataDir, name, data) {
  await writeJson(join(dataDir, `${name}.json`), {
    lastUpdated: data.lastUpdated || "",
    sections: data.sections || [],
  });
}

// ====================================================================
// Helpers
// ====================================================================

async function writeJson(filePath, data) {
  await writeFile(filePath, JSON.stringify(data, null, 2) + "\n", "utf-8");
}

/** Convert slug like "will-pasko" to camelCase variable name "willPasko" */
function slugToVar(slug) {
  return String(slug)
    .replace(/[^a-zA-Z0-9-]/g, "-")
    .split("-")
    .filter(Boolean)
    .map((part, i) =>
      i === 0 ? part.toLowerCase() : part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
    )
    .join("");
}

/** Convert any string to a URL-safe slug */
function toSlug(str) {
  return String(str)
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-|-$/g, "")
    .slice(0, 50);
}
